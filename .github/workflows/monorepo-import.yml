name: Monorepo Import

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Si-core
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Configure branch
        run: |
          git checkout -B codex/import-all-repos
      - name: Configure git user
        run: |
          git config user.name "sovereign-codex-bot"
          git config user.email "bot@users.noreply.github.com"
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.8
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install -r --no-frozen-lockfile
      - name: Run monorepo import
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: bash scripts/monorepo-import.sh
      - name: Prepare commit
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git add -A
          git commit -m "chore: import sovereign-codex repositories"
          echo "no_changes=false" >> "$GITHUB_OUTPUT"
      - name: Push branch
        if: steps.commit.outputs.no_changes != 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git
          git push --force-with-lease origin HEAD:codex/import-all-repos
      - name: Create or update PR
        if: steps.commit.outputs.no_changes != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          pr_body="This automated workflow imports every repository from sovereign-codex into the Si-core monorepo using git subtree (full history, README merge policy)."
          if gh pr view codex/import-all-repos >/dev/null 2>&1; then
            gh pr edit codex/import-all-repos --title "Phase 3: Import ALL repos (full history)" --body "$pr_body"
          else
            gh pr create --title "Phase 3: Import ALL repos (full history)" --body "$pr_body" --head codex/import-all-repos --base main
          fi
